\chapter{Development and Validation of Biologically-Informed CT
Habitats}\label{development-and-validation-of-biologically-informed-ct-habitats}

This annex provides extended methods and results supporting Chapter 7.

\subsection{C.1. CT--mpMRI Co-Registration: Extended
Methods}\label{c.1.-ctmpmri-co-registration-extended-methods}

Prior to registration, all images were cropped to a tumor-centered
bounding box with a 5--7 mm margin beyond the segmentation boundary.
Cropping served two purposes: it reduced computational cost and focused
the registration algorithm on the tumor region, avoiding spurious
alignment driven by distant anatomical structures (e.g., ribs, spine)
that may differ in position between CT and MRI acquisitions.

Images were resampled to 2×2×2 mm isotropic resolution to match the
T2-weighted reference. Resampling to a common grid is necessary for
voxelwise comparison; we chose the T2w resolution as the reference
because it represented the coarsest native resolution among the
sequences and avoided artificial upsampling of M RI data.

Three pipelines were required:

\textbf{CT→T2w:} Aligns contrast-enhanced CT to the anatomical MRI
reference. This is the most challenging registration due to differences
in tissue contrast between modalities.

\textbf{DWI→T2w:} Aligns diffusion-weighted images (and derived ADC
maps) to T2w. DWI and T2w are both MRI sequences, but DWI suffers from
geometric distortion, particularly near air-tissue interfaces.

\textbf{DCE→T2w:} Aligns dynamic contrast-enhanced images (and derived
perfusion maps) to T2w. DCE images were acquired with a GRE sequence at
different resolution than T2w.

All registrations were performed using NiftyReg (reg\_aladin for
rigid/affine, reg\_f3d for B-spline deformable registration). The
pipeline proceeded sequentially: rigid registration was performed first;
if affine registration improved DSC, it replaced the rigid result; if
B-spline registration improved DSC further, it replaced the affine
result. This conservative approach avoided overfitting from unnecessary
deformable registration.

Registration quality was assessed by computing the Dice similarity
coefficient between the tumor mask on the fixed image (T2w) and the
warped tumor mask from the moving image. Tumors with CT→T2w DSC
\textless{} 0.50 were excluded from analysis, as low overlap indicates
registration failure that would propagate errors into habitat
comparisons

\subsection{C.2. Handcrafted Feature Reduction by Correlation
Analysis}\label{c.2.-handcrafted-feature-reduction-by-correlation-analysis}

Chapter 6 identified 26 radiomics features with acceptable repeatability
and reproducibility for liver lesions. However, many of these features
are highly correlated, capturing overlapping information. Clustering on
redundant features can distort distance metrics and bias cluster
assignments toward the correlated feature set.

To obtain a non-redundant feature set, we computed pairwise Spearman
correlations across all voxels in the PREDICT cohort. Features with
\textbar ρ\textbar{} ≥ 0.80 were considered redundant. From each
correlated pair, we retained the feature with higher mean repeatability
(ICC) from the Chapter 6 analysis. This procedure reduced the 26 precise
features to 6 non-redundant features:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  10th percentile intensity (first-order)
\item
  GLDM dependence entropy
\item
  GLDM small dependence high gray level emphasis
\item
  GLRLM gray level non-uniformity
\item
  GLRLM run length non-uniformity
\item
  NGTDM coarseness
\end{enumerate}

\hyperref[_Ref219944195]{Figure C.1} shows the correlation matrix of the
original 26 features and \hyperref[_Ref219944203]{Figure C.2} shows the
retained features, which span different texture families (GLDM, GLRLM,
NGTDM) and capture distinct aspects of local intensity variation,
ensuring that the clustering input is diverse rather than dominated by a
single texture property.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.9\textwidth]{fig_C_2.pdf}
\caption{Correlation matrix of the 26 precise handcrafted radiomics features identified in Chapter 6.
Pairwise Spearman correlations computed across all voxels in the PREDICT
cohort. Features with $|\rho| \geq 0.80$ were considered redundant.}
\label{fig:C.2}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.85\textwidth]{fig_C_3.pdf}
\caption{Correlation matrix of the 6 selected precise handcrafted radiomics features identified in Chapter 6.
The 6 non-redundant features retained for habitat computation are
highlighted: 10th percentile intensity, GLDM dependence entropy, GLDM
small dependence high gray level emphasis, GLRLM gray level
non-uniformity, GLRLM run length non-uniformity, and NGTDM coarseness.}
\label{fig:C.3}
\end{figure}

\subsection{C.3. Sensitivity Analysis for Number of Habitats
(K)}\label{c.3.-sensitivity-analysis-for-number-of-habitats-k}

To determine the optimal number of habitats, we compared K = 2, 3, and 4
using the handcrafted feature representation. For each K, we computed
habitats and assessed their separation of mpMRI-derived biophysical
metrics using Kendall\textquotesingle s W effect size.

\begin{itemize}
\item
  \textbf{K = 2} achieved the highest effect sizes for most metrics but
  collapsed biologically distinct compartments into a single
  "vascularized" cluster. The two-habitat solution could not distinguish
  the cellular-perfused tumor (H2) from the vascular interface (H3).
\item
  \textbf{K = 3} provided the best interpretive balance. It separated
  the avascular core (H1) from two distinct vascularized phenotypes: a
  cellular-perfused compartment with high Ktrans (H2) and a vascular
  compartment with high fv but moderate Ktrans (H3). This three-way
  distinction aligns with the known histological architecture of
  colorectal liver metastases.
\item
  \textbf{K = 4} introduced a fourth habitat by splitting H3 into two
  subgroups. However, this split showed no clear biological
  rationale---both subhabitats had similar mpMRI profiles---and the
  fourth cluster showed unstable membership across bootstrap resampling
  (ARI = 0.91 vs. 0.97 for K = 3).
\end{itemize}

Based on these findings, K = 3 was selected as the final model
configuration.

{\def\LTcaptype{none} % do not increment counter
\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0512}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0692}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0672}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1118}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1040}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0981}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0903}}
  >{\centering\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.4083}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\centering
\textbf{K}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{fv\_W}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{fv\_p}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Ktrans\_W}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Ktrans\_p}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{ADCt\_W}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{ADCt\_p}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Interpretation}
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2 & 0.98 & 0.002 & 0.78 & 0.014 & 0.62 & 0.049 & Strong separation but
oversimplified; merges biologically distinct vascular phenotypes \\
3 & 0.67 & 0.005 & 0.52 & 0.018 & 0.16 & 0.328 & Best balance; separates
vascular gradient while identifying cellular-perfused compartment \\
4 & 0.85 & 0 & 0.37 & 0.025 & 0.32 & 0.039 & Fourth habitat splits H3
without biological justification; unstable across bootstrap \\
\end{longtable}
}

\textbf{Table C.1 \textbar{} Biophysical separation
(Kendall\textquotesingle s W) across different numbers of habitats (K).}

\subsection{C.4. Technical Validation: Extended
Results}\label{c.4.-technical-validation-extended-results}

\begin{itemize}
\item
  \textbf{Initialization stability:} All representations achieved ARI
  \textgreater{} 0.96, indicating that clustering solutions were
  reproducible regardless of random seed initialization.
\item
  \textbf{Data stability:} All representations showed high bootstrap
  stability (median ARI \textgreater{} 0.96), indicating that habitat
  definitions were not driven by a few influential patients.
\item
  \textbf{Spatial coherence:} Handcrafted features produced the highest
  Moran\textquotesingle s I (0.804), indicating strong spatial
  autocorrelation---habitats formed contiguous regions rather than
  scattered voxels. DL-SALSA and DL-FM produced lower spatial coherence
  (0.513--0.622), reflecting more fragmented "salt-and-pepper" patterns.
  Raw HU showed the lowest spatial coherence (0.420).
\end{itemize}

The combination of high initialization stability, adequate data
stability, and superior spatial coherence supported the selection of
handcrafted features for the final CT habitat model.

{\def\LTcaptype{none} % do not increment counter
\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.1838}}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2015}}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.3137}}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2919}}@{}}
\toprule\noalign{}
\multicolumn{4}{@{}>{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.9909} + 6\tabcolsep}@{}}{%
\begin{minipage}[b]{\linewidth}\centering
Table C.2 \textbar{} Technical robustness of candidate CT feature
representations.
\end{minipage}} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
& \textbf{Initialization Stability (ARI)} & \textbf{Data Stability
(ARI)}

{[}Median (IQR){]} & \textbf{Moran's I}

{[}Mean ± SD{]} \\
\begin{minipage}[t]{\linewidth}\centering
\begin{quote}
Raw HU
\end{quote}
\end{minipage} & 0.965 & \textbf{0.991 (0.980-0.997)} & 0.420
±0.0.143 \\
\begin{minipage}[t]{\linewidth}\centering
\begin{quote}
Handcrafted
\end{quote}
\end{minipage} & \textbf{0.997} & 0.966 (0.959-0.985) & \textbf{0.804
±0.056} \\
\begin{minipage}[t]{\linewidth}\centering
\begin{quote}
DL-SALSA
\end{quote}
\end{minipage} & 0.984 & 0.985 (0.977-0.988) & 0.513 ±0.110 \\
\begin{minipage}[t]{\linewidth}\centering
\begin{quote}
DL-FM
\end{quote}
\end{minipage} & 0.978 & 0.989 (0.976-0.992) & 0.622 ±0.119 \\
\end{longtable}
}

\subsection{C.5. mpMRI Characterization: Pairwise
Comparison}\label{c.5.-mpmri-characterization-pairwise-comparison}

For metrics with significant Friedman test (p \textless{} 0.05,
BH-corrected), we report Wilcoxon signed-rank tests comparing habitat
pairs. Effect size r = Z/√N. All p-values are BH-corrected within each
metric. N = 10 patients.

\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.0901}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1714}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1307}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1712}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1306}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1734}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1328}}@{}}
\caption{\textbf{Table C.3 \textbar{} Post-hoc pairwise comparisons for
mpMRI metrics across CT habitats.}}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\centering
\textbf{Metric}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H2\_p\_BH}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H2\_r}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H3\_p\_BH}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H3\_r}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H2\_vs\_H3\_p\_BH}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H2\_vs\_H3\_r}
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\centering
\textbf{Metric}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H2\_p\_BH}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H2\_r}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H3\_p\_BH}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H1\_vs\_H3\_r}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H2\_vs\_H3\_p\_BH}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{H2\_vs\_H3\_r}
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
ADCt & 0.029 & 0.82 & 0.24 & 0.44 & 1 & 0 \\
ADCv & 0.126 & 0.55 & 0.111 & 0.66 & 0.232 & 0.38 \\
fv & 0.375 & 0.28 & 0.006 & 0.98 & 0.006 & 0.91 \\
D0 & 0.049 & 0.62 & 0.003 & 0.98 & 0.003 & 0.98 \\
T2star & 0.02 & 0.74 & 0.003 & 0.98 & 0.003 & 0.98 \\
T1 & 0.029 & 0.74 & 0.012 & 0.91 & 0.037 & 0.66 \\
Ktrans & 0.015 & 0.87 & 0.015 & 0.82 & 0.16 & 0.44 \\
\end{longtable}

\textbf{Key findings:}

• \textbf{Vascular gradient (H1 → H3):} fv, D0, T2*, and T1 showed
significant differences between H1 and H3, with large effect sizes (r
\textgreater{} 0.90), confirming a vascular gradient from the avascular
core to the vascular rim.

• \textbf{Cellular peak (H2):} ADCt was significantly lower in H2 than
H1 (p = 0.029, r = 0.82), indicating H2 as the most cellular habitat.
Ktrans was significantly higher in H2 than H1 (p = 0.015, r = 0.87),
consistent with leaky tumor neovessels.

• \textbf{H2 vs H3 distinction:} fv distinguished H2 from H3 (p =
0.006), but Ktrans did not (p = 0.160). This supports the interpretation
that H3 represents a vascular compartment with mature (less leaky)
vessels, possibly reflecting partial volume with normal liver.

\subsection{C.6. Habitat-Histology
Correlations}\label{c.6.-habitat-histology-correlations}

As an exploratory analysis, we computed Spearman correlations between
whole-tumor habitat proportions and histological tissue percentages in
the POEM cohort (N = 6 tumors). Direct voxel-to-voxel co-registration
between CT and histology was not feasible; correlations therefore
reflect whole-tumor associations only.

\begin{figure}[htbp]
\centering
\includegraphics[width=0.9\textwidth]{fig_C_1.pdf}
\caption{Exploratory correlations between CT habitat proportions and histological tissue percentages (POEM cohort, N = 6).
Each panel shows the relationship between a habitat proportion (rows:
H1, H2, H3) and a histological tissue percentage (columns: necrosis,
fibrosis, viable tumor). Spearman correlation coefficients ($\rho$) and
p-values are shown. All correlations were non-significant, reflecting
the small sample size and CT's inability to distinguish
necrosis from fibrosis within the avascular compartment.}
\label{fig:C.1}
\end{figure}

\textbf{Table C.4 \textbar{} Spearman correlations between habitat
proportions and histological tissue percentages.}

{\def\LTcaptype{none} % do not increment counter
\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.0949}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1451}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1246}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1404}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1199}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1979}}
  >{\centering\arraybackslash}p{(\linewidth - 12\tabcolsep) * \real{0.1774}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\centering
\textbf{Habitat}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Necrosis\_rho}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Necrosis\_p}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Fibrosis\_rho}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Fibrosis\_p}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Viable\_Tumor\_rho}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Viable\_Tumor\_p}
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
H1 & 0.49 & 0.329 & -0.6 & 0.208 & -0.31 & 0.544 \\
H2 & -0.37 & 0.468 & 0.43 & 0.397 & 0.14 & 0.787 \\
H3 & 0.03 & 0.957 & 0.77 & 0.072 & -0.09 & 0.872 \\
\end{longtable}
}

All correlations were weak to moderate and non-significant. Several
trends were observed:

\begin{itemize}
\item
  \textbf{H1 and necrosis:} A positive trend (ρ = 0.49) suggests that
  the avascular habitat may partially capture necrotic tissue,
  consistent with its biological profile (low vascularity, low
  cellularity).
\item
  \textbf{H1 and fibrosis:} A negative trend (ρ = −0.60) suggests that
  H1 does not specifically correspond to fibrosis. This is expected: CT
  cannot distinguish necrosis from fibrosis, and both may appear as
  avascular tissue.
\item
  \textbf{H3 and fibrosis:} The strongest trend observed (ρ = 0.77, p =
  0.072) suggests a potential association between the vascular habitat
  and fibrotic tissue. However, this finding is difficult to interpret
  biologically and may reflect confounding by tumor size or treatment
  history.
\end{itemize}

The sample size (N = 6) provides insufficient power to detect moderate
correlations. Additionally, the scale mismatch between voxel-level
imaging (mm resolution) and microscopic histology (μm resolution),
combined with tissue deformation during resection and processing, limits
the interpretability of whole-tumor correlations. These exploratory
findings should be interpreted with caution and require validation in
larger cohorts with spatially co-registered imaging and histology.

Annex D